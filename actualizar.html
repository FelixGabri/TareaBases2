<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actualizar Empleado</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: white;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }

        h1 {
            text-align: center;
            margin-bottom: 2rem;
            color: #333;
        }

        .employee-info {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border: 1px solid #e0e0e0;
        }

        .info-item {
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }

        .info-label {
            font-weight: bold;
            color: #555;
        }

        .info-value {
            color: #333;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #ff69b4;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin: 0.25rem;
        }

        .btn-primary {
            background-color: #ff69b4;
            color: white;
        }

        .btn-primary:hover {
            background-color: #ff1493;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error-message {
            background-color: #ffe6e6;
            color: #d63384;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            text-align: center;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            text-align: center;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 1rem;
            color: #ff69b4;
            text-decoration: none;
            cursor: pointer;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .debug-info {
            background-color: #fff3cd;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-size: 0.8rem;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function ActualizarEmpleado() {
            const [employee, setEmployee] = useState(null);
            const [puestos, setPuestos] = useState([]);
            const [loggedInUser, setLoggedInUser] = useState(null);
            const [formData, setFormData] = useState({
                idPuesto: '',
                valorDocumentoIdentidad: '',
                nombre: ''
            });
            const [loading, setLoading] = useState(false);
            const [updating, setUpdating] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const [debugInfo, setDebugInfo] = useState('');

            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const employeeId = urlParams.get('id');
                const employeeDataParam = urlParams.get('employeeData');

                const storedUserId = localStorage.getItem('userId');
                const storedUsername = localStorage.getItem('username');
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                
                if (!isLoggedIn) {
                    setError('Debes iniciar sesi√≥n primero');
                    setLoading(false);
                    return;
                }

                if (storedUserId) {
                    setLoggedInUser({ 
                        Id: storedUserId, 
                        Nombre: storedUsername || 'Usuario' 
                    });
                } else {
                    setError('No se encontr√≥ informaci√≥n de usuario logueado');
                    setLoading(false);
                    return;
                }

                if (!employeeId) {
                    setError('No se especific√≥ el ID del empleado');
                    setLoading(false);
                    return;
                }

                if (employeeDataParam) {
                    try {
                        const employeeData = JSON.parse(decodeURIComponent(employeeDataParam));
                        console.log('üìù Datos del empleado desde tabla:', employeeData);
                        setEmployee(employeeData);
                        setFormData({
                            idPuesto: employeeData.IdPuesto ? employeeData.IdPuesto.toString() : '',
                            valorDocumentoIdentidad: employeeData.ValorDocumentoIdentidad || '',
                            nombre: employeeData.Nombre || ''
                        });
                        setDebugInfo('‚úÖ Datos cargados desde tabla');
                    } catch (error) {
                        console.error('Error parseando datos del empleado:', error);
                        cargarEmpleadoDesdeAPI(employeeId);
                    }
                } else {
                    cargarEmpleadoDesdeAPI(employeeId);
                }

                cargarPuestos();
            }, []);

            const cargarEmpleadoDesdeAPI = async (employeeId) => {
                try {
                    setLoading(true);
                    console.log('üîÑ Cargando empleado desde API, ID:', employeeId);
                    
                    const response = await fetch(`http://25.46.106.44:3000/api/empleados/${employeeId}`);
                    
                    if (response.ok) {
                        const employeeData = await response.json();
                        console.log('üìä Empleado cargado desde API:', employeeData);
                        
                        if (employeeData && employeeData.Id) {
                            setEmployee(employeeData);
                            setFormData({
                                idPuesto: employeeData.IdPuesto ? employeeData.IdPuesto.toString() : '',
                                valorDocumentoIdentidad: employeeData.ValorDocumentoIdentidad || '',
                                nombre: employeeData.Nombre || ''
                            });
                            setDebugInfo('‚úÖ Datos cargados desde API');
                        } else {
                            setError('Empleado no encontrado en la respuesta del API');
                        }
                    } else {
                        const errorText = await response.text();
                        throw new Error(`Error ${response.status}: ${errorText}`);
                    }
                } catch (error) {
                    console.error('Error cargando empleado:', error);
                    setError(`Error al cargar datos del empleado: ${error.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const cargarPuestos = async () => {
                try {
                    console.log('üîÑ Cargando puestos...');
                    const response = await fetch('http://25.46.106.44:3000/api/puestos');
                    
                    if (response.ok) {
                        const puestosData = await response.json();
                        console.log('üìä Puestos cargados:', puestosData);
                        setPuestos(puestosData);
                    } else {
                        console.log('‚ö†Ô∏è Usando puestos de respaldo');
                        setPuestos([
                            { Id: 1, Nombre: 'Alba√±il' },
                            { Id: 2, Nombre: 'Asistente' },
                            { Id: 3, Nombre: 'Cajero' },
                            { Id: 4, Nombre: 'Camarero' },
                            { Id: 5, Nombre: 'Conductor' },
                            { Id: 6, Nombre: 'Conserje' },
                            { Id: 7, Nombre: 'Cuidador' },
                            { Id: 8, Nombre: 'Fontanero' },
                            { Id: 9, Nombre: 'Ni√±era' },
                            { Id: 10, Nombre: 'Recepcionista' }
                        ]);
                    }
                } catch (error) {
                    console.error('Error cargando puestos:', error);
                    // Puestos de respaldo
                    setPuestos([
                        { Id: 1, Nombre: 'Alba√±il' },
                        { Id: 2, Nombre: 'Asistente' },
                        { Id: 3, Nombre: 'Cajero' },
                        { Id: 4, Nombre: 'Camarero' },
                        { Id: 5, Nombre: 'Conductor' },
                        { Id: 6, Nombre: 'Conserje' },
                        { Id: 7, Nombre: 'Cuidador' },
                        { Id: 8, Nombre: 'Fontanero' },
                        { Id: 9, Nombre: 'Ni√±era' },
                        { Id: 10, Nombre: 'Recepcionista' }
                    ]);
                }
            };

            const handleInputChange = (field, value) => {
                setFormData(prev => ({
                    ...prev,
                    [field]: value
                }));
            };

            const actualizarEmpleado = async () => {
                if (!employee || !loggedInUser) return;

                setUpdating(true);
                setError('');
                setSuccess('');

                try {
                    const updateData = {
                        idPuesto: parseInt(formData.idPuesto),
                        valorDocumentoIdentidad: formData.valorDocumentoIdentidad,
                        nombre: formData.nombre,
                        userId: parseInt(loggedInUser.Id)
                    };

                    console.log('üì§ Enviando datos de actualizaci√≥n:', updateData);

                    const response = await fetch(`http://25.46.106.44:3000/api/empleados/${employee.Id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updateData)
                    });

                    const result = await response.json();
                    console.log('üì• Respuesta del servidor:', result);

                    if (result.success) {
                        setSuccess('‚úÖ Empleado actualizado correctamente');
                        
                        // Actualizar datos locales
                        setEmployee(prev => ({
                            ...prev,
                            Nombre: formData.nombre,
                            ValorDocumentoIdentidad: formData.valorDocumentoIdentidad,
                            IdPuesto: parseInt(formData.idPuesto)
                        }));
                    } else {
                        setError(result.message || 'Error al actualizar empleado');
                    }
                } catch (error) {
                    console.error('Error actualizando empleado:', error);
                    setError('Error de conexi√≥n con el servidor');
                } finally {
                    setUpdating(false);
                }
            };

            const eliminarEmpleado = async () => {
                if (!employee || !loggedInUser || !confirm('¬øEst√°s seguro de que deseas eliminar este empleado? Esta acci√≥n no se puede deshacer.')) {
                    return;
                }

                setUpdating(true);
                setError('');
                setSuccess('');

                try {
                    const deleteData = {
                        userId: parseInt(loggedInUser.Id)
                    };

                    console.log('üóëÔ∏è Enviando solicitud de eliminaci√≥n:', deleteData);

                    const response = await fetch(`http://25.46.106.44:3000/api/empleados/${employee.Id}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(deleteData)
                    });

                    const result = await response.json();
                    console.log('üì• Respuesta de eliminaci√≥n:', result);

                    if (result.success) {
                        setSuccess('‚úÖ Empleado eliminado correctamente');
                        
                        setTimeout(() => {
                            window.close();
                        }, 2000);
                    } else {
                        setError(result.message || 'Error al eliminar empleado');
                    }
                } catch (error) {
                    console.error('Error eliminando empleado:', error);
                    setError('Error de conexi√≥n con el servidor');
                } finally {
                    setUpdating(false);
                }
            };

            const abrirMovimientos = () => {
                if (employee && loggedInUser) {
                    window.open(`movimientos.html?id=${employee.Id}`, '_blank');
                }
            };

            const goBack = () => {
                window.close();
            };

            if (loading) {
                return React.createElement('div', { className: 'container' },
                    React.createElement('div', { className: 'loading' }, 'Cargando datos del empleado...')
                );
            }

            if (!employee) {
                return React.createElement('div', { className: 'container' },
                    React.createElement('h1', null, 'Empleado no encontrado'),
                    React.createElement('button', { 
                        className: 'btn btn-secondary',
                        onClick: goBack
                    }, 'Cerrar')
                );
            }

            return React.createElement('div', { className: 'container' },
                // Informaci√≥n de debug
                debugInfo && React.createElement('div', { className: 'debug-info' }, debugInfo),
                
                React.createElement('a', { 
                    className: 'back-link',
                    onClick: goBack
                }, '‚Üê Volver a la tabla'),
                
                React.createElement('h1', null, 'Actualizar Empleado'),
                
                // Informaci√≥n actual del empleado
                React.createElement('div', { className: 'employee-info' },
                    React.createElement('h3', { style: { marginBottom: '1rem', color: '#333' } }, 'Informaci√≥n Actual'),
                    React.createElement('div', { className: 'info-item' },
                        React.createElement('span', { className: 'info-label' }, 'ID:'),
                        React.createElement('span', { className: 'info-value' }, employee.Id)
                    ),
                    React.createElement('div', { className: 'info-item' },
                        React.createElement('span', { className: 'info-label' }, 'Nombre:'),
                        React.createElement('span', { className: 'info-value' }, employee.Nombre || 'N/A')
                    ),
                    React.createElement('div', { className: 'info-item' },
                        React.createElement('span', { className: 'info-label' }, 'C√©dula:'),
                        React.createElement('span', { className: 'info-value' }, employee.ValorDocumentoIdentidad || 'N/A')
                    ),
                    React.createElement('div', { className: 'info-item' },
                        React.createElement('span', { className: 'info-label' }, 'Puesto Actual:'),
                        React.createElement('span', { className: 'info-value' }, 
                            puestos.find(p => p.Id === employee.IdPuesto)?.Nombre || 
                            employee.PuestoNombre || 
                            `ID: ${employee.IdPuesto}`)
                    ),
                    React.createElement('div', { className: 'info-item' },
                        React.createElement('span', { className: 'info-label' }, 'Saldo Vacaciones:'),
                        React.createElement('span', { className: 'info-value' }, 
                            `${employee.SaldoVacaciones !== undefined ? employee.SaldoVacaciones : 'N/A'} d√≠as`)
                    )
                ),

                // Mensajes de error/√©xito
                error && React.createElement('div', { className: 'error-message' }, error),
                success && React.createElement('div', { className: 'success-message' }, success),

                // Formulario de actualizaci√≥n
                React.createElement('form', { onSubmit: (e) => e.preventDefault() },
                    React.createElement('div', { className: 'form-group' },
                        React.createElement('label', null, 'Nuevo Puesto:'),
                        React.createElement('select', {
                            value: formData.idPuesto,
                            onChange: (e) => handleInputChange('idPuesto', e.target.value),
                            disabled: updating
                        },
                            React.createElement('option', { value: '' }, 'Seleccionar nuevo puesto'),
                            puestos.map(puesto => 
                                React.createElement('option', { 
                                    key: puesto.Id, 
                                    value: puesto.Id 
                                }, puesto.Nombre)
                            )
                        )
                    ),

                    React.createElement('div', { className: 'form-group' },
                        React.createElement('label', null, 'C√©dula:'),
                        React.createElement('input', {
                            type: 'text',
                            value: formData.valorDocumentoIdentidad,
                            onChange: (e) => handleInputChange('valorDocumentoIdentidad', e.target.value),
                            placeholder: 'Ej: 123456789',
                            disabled: updating
                        })
                    ),

                    React.createElement('div', { className: 'form-group' },
                        React.createElement('label', null, 'Nombre Completo:'),
                        React.createElement('input', {
                            type: 'text',
                            value: formData.nombre,
                            onChange: (e) => handleInputChange('nombre', e.target.value),
                            placeholder: 'Ej: Juan P√©rez Garc√≠a',
                            disabled: updating
                        })
                    ),

                    // Botones de acci√≥n
                    React.createElement('div', { className: 'button-group' },
                        React.createElement('div', { className: 'action-buttons' },
                            React.createElement('button', {
                                className: 'btn btn-primary',
                                onClick: actualizarEmpleado,
                                disabled: updating || !formData.idPuesto || !formData.valorDocumentoIdentidad || !formData.nombre
                            }, updating ? 'Actualizando...' : 'Actualizar Empleado'),
                            
                            React.createElement('button', {
                                className: 'btn btn-success',
                                onClick: abrirMovimientos,
                                disabled: updating
                            }, 'Ver Movimientos')
                        ),
                        
                        React.createElement('button', {
                            className: 'btn btn-danger',
                            onClick: eliminarEmpleado,
                            disabled: updating
                        }, 'Eliminar Empleado')
                    )
                )
            );
        }

        // Renderizar la aplicaci√≥n con React 18
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(ActualizarEmpleado));
    </script>
</body>
</html>