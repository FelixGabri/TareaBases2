<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movimientos del Empleado</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: white;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }

        h1 {
            text-align: center;
            margin-bottom: 2rem;
            color: #333;
        }

        .employee-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .employee-details {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .employee-detail {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
        }

        .saldo-vacaciones {
            text-align: center;
            padding: 0.5rem 1rem;
            background: white;
            border-radius: 6px;
            border: 2px solid #ff69b4;
        }

        .saldo-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.25rem;
        }

        .saldo-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff69b4;
        }

        .movements-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }

        .movements-table th,
        .movements-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9rem;
        }

        .movements-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        .movements-table tr:hover {
            background-color: #f8f9fa;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background-color: #ff69b4;
            color: white;
        }

        .btn-primary:hover {
            background-color: #ff1493;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .no-data {
            text-align: center;
            padding: 2rem;
            color: #666;
            font-style: italic;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .positive {
            color: #28a745;
            font-weight: bold;
        }

        .negative {
            color: #dc3545;
            font-weight: bold;
        }

        .button-container {
            text-align: center;
            margin-top: 2rem;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function Movimientos() {
            const [employee, setEmployee] = useState(null);
            const [movimientos, setMovimientos] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const employeeId = urlParams.get('id');

                if (!employeeId) {
                    setLoading(false);
                    return;
                }

                cargarDatos(employeeId);
            }, []);

            const cargarDatos = async (employeeId) => {
                setLoading(true);
                try {
                    const empleadoResponse = await fetch(`http://25.46.106.44:3000/api/empleados`);
                    if (empleadoResponse.ok) {
                        const employees = await empleadoResponse.json();
                        const employeeData = employees.find(emp => emp.Id == employeeId);
                        
                        if (employeeData) {
                            setEmployee(employeeData);
                        }
                    }

                    // Cargar movimientos del empleado
                    console.log(`üìã Cargando movimientos para empleado ID: ${employeeId}`);
                    const movimientosResponse = await fetch(`http://25.46.106.44:3000/api/empleados/${employeeId}/movimientos`);
                    
                    if (movimientosResponse.ok) {
                        const movimientosData = await movimientosResponse.json();
                        console.log('üìä Movimientos recibidos:', movimientosData);
                        setMovimientos(movimientosData);
                    } else {
                        console.error('‚ùå Error en respuesta de movimientos:', movimientosResponse.status);
                    }
                    
                } catch (error) {
                    console.error('Error cargando datos:', error);
                } finally {
                    setLoading(false);
                }
            };

            const goBack = () => {
                window.close();
            };

            const agregarMovimiento = () => {
                if (employee) {
                    window.open(`insertar-movimiento.html?id=${employee.Id}`, '_blank');
                }
            };

            const recargarDatos = () => {
                const urlParams = new URLSearchParams(window.location.search);
                const employeeId = urlParams.get('id');
                if (employeeId) {
                    cargarDatos(employeeId);
                }
            };

            // Funci√≥n para formatear fecha
            const formatFecha = (fecha) => {
                if (!fecha) return 'N/A';
                try {
                    return new Date(fecha).toLocaleDateString('es-ES');
                } catch (e) {
                    return fecha;
                }
            };

            const formatFechaHora = (fecha) => {
                if (!fecha) return 'N/A';
                try {
                    return new Date(fecha).toLocaleString('es-ES');
                } catch (e) {
                    return fecha;
                }
            };

            const getTipoMovimiento = (movimiento) => {
                if (movimiento.TipoMovimiento) return movimiento.TipoMovimiento;
                
                const tipoMap = {
                    1: 'Cumplir mes',
                    2: 'Bono vacacional', 
                    3: 'Reversion Debito',
                    4: 'Disfrute de vacaciones',
                    5: 'Venta de vacaciones',
                    6: 'Reversion de Credito'
                };
                
                return tipoMap[movimiento.IdTipoMovimiento] || tipoMap[movimiento.TipoMovimientoId] || `Tipo ${movimiento.IdTipoMovimiento || movimiento.TipoMovimientoId}`;
            };

            const esCredito = (movimiento) => { 
    if ([1, 2, 3].includes(movimiento.IdTipoMovimiento)) {
        return true; 
    }
    if ([4, 5, 6].includes(movimiento.IdTipoMovimiento)) {
        return false; 
    }
    
    if (movimiento.TipoMovimiento) {
        if (movimiento.TipoMovimiento.includes('Cumplir') || 
            movimiento.TipoMovimiento.includes('Bono') ||
            movimiento.TipoMovimiento.includes('Reversion Debito')) {
            return true;
        }
        if (movimiento.TipoMovimiento.includes('Disfrute') ||
            movimiento.TipoMovimiento.includes('Venta') ||
            movimiento.TipoMovimiento.includes('Reversion de Credito')) {
            return false;
        }
    }
    
    return movimiento.Monto >= 0;
};

            const formatMonto = (movimiento) => {
                const esMovimientoCredito = esCredito(movimiento);
                const montoAbsoluto = Math.abs(movimiento.Monto);
                
                if (esMovimientoCredito) {
                    return React.createElement('span', { 
                        className: 'positive'
                    }, `+${montoAbsoluto} d√≠as`);
                } else {
                    return React.createElement('span', { 
                        className: 'negative'
                    }, `-${montoAbsoluto} d√≠as`);
                }
            };

            if (loading) {
                return React.createElement('div', { className: 'container' },
                    React.createElement('div', { className: 'loading' }, 'Cargando movimientos...')
                );
            }

            if (!employee) {
                return React.createElement('div', { className: 'container' },
                    React.createElement('h1', null, 'Empleado no encontrado'),
                    React.createElement('button', { 
                        className: 'btn btn-secondary',
                        onClick: goBack
                    }, 'Cerrar')
                );
            }

            return React.createElement('div', { className: 'container' },
                // Header con acciones
                React.createElement('div', { className: 'header-actions' },
                    React.createElement('button', { 
                        className: 'btn btn-secondary',
                        onClick: goBack
                    }, '‚Üê Cerrar'),
                    React.createElement('div', { style: { display: 'flex', gap: '1rem' } },
                        React.createElement('button', {
                            className: 'btn btn-primary',
                            onClick: recargarDatos
                        }, 'Recargar'),
                        React.createElement('button', {
                            className: 'btn btn-primary',
                            onClick: agregarMovimiento
                        }, 'Agregar Movimiento')
                    )
                ),
                
                React.createElement('h1', null, 'Movimientos de Vacaciones'),

                // Informaci√≥n del empleado en una l√≠nea
                React.createElement('div', { className: 'employee-summary' },
                    React.createElement('div', { className: 'employee-details' },
                        React.createElement('div', { className: 'employee-detail' },
                            React.createElement('span', { className: 'detail-label' }, 'ID:'),
                            React.createElement('span', { className: 'detail-value' }, employee.Id)
                        ),
                        React.createElement('div', { className: 'employee-detail' },
                            React.createElement('span', { className: 'detail-label' }, 'Nombre:'),
                            React.createElement('span', { className: 'detail-value' }, employee.Nombre)
                        ),
                        React.createElement('div', { className: 'employee-detail' },
                            React.createElement('span', { className: 'detail-label' }, 'C√©dula:'),
                            React.createElement('span', { className: 'detail-value' }, employee.ValorDocumentoIdentidad)
                        ),
                        React.createElement('div', { className: 'employee-detail' },
                            React.createElement('span', { className: 'detail-label' }, 'Puesto:'),
                            React.createElement('span', { className: 'detail-value' }, employee.PuestoNombre)
                        )
                    ),
                    React.createElement('div', { className: 'saldo-vacaciones' },
                        React.createElement('div', { className: 'saldo-label' }, 'Saldo Vacaciones'),
                        React.createElement('div', { className: 'saldo-value' }, `${employee.SaldoVacaciones} d√≠as`)
                    )
                ),

                // Contador de resultados
                React.createElement('p', { style: { marginBottom: '1rem', color: '#666' } }, 
                    `Mostrando ${movimientos.length} movimientos`),

                // Tabla de movimientos
                React.createElement('table', { className: 'movements-table' },
                    React.createElement('thead', null,
                        React.createElement('tr', null,
                            React.createElement('th', null, 'Fecha'),
                            React.createElement('th', null, 'Tipo de Movimiento'),
                            React.createElement('th', null, 'Monto'),
                            React.createElement('th', null, 'Nuevo Saldo'),
                            React.createElement('th', null, 'Usuario'),
                            React.createElement('th', null, 'IP'),
                            React.createElement('th', null, 'Estampa de Tiempo')
                        )
                    ),
                    React.createElement('tbody', null,
                        movimientos.length > 0 ? (
                            movimientos.map(movimiento => {
                                return React.createElement('tr', { key: movimiento.Id },
                                    React.createElement('td', null, formatFecha(movimiento.Fecha)),
                                    React.createElement('td', null, getTipoMovimiento(movimiento)),
                                    React.createElement('td', null, formatMonto(movimiento)),
                                    React.createElement('td', null, `${movimiento.NuevoSaldo} d√≠as`),
                                    React.createElement('td', null, movimiento.UsuarioNombre || 'Sistema'),
                                    React.createElement('td', null, movimiento.IP || movimiento.PostInIP || 'N/A'),
                                    React.createElement('td', null, 
                                        formatFechaHora(movimiento.FechaMovimiento || movimiento.PostTime)
                                    )
                                );
                            })
                        ) : (
                            React.createElement('tr', null,
                                React.createElement('td', { 
                                    colSpan: '7', 
                                    style: { textAlign: 'center', padding: '2rem' } 
                                }, 'No hay movimientos registrados para este empleado')
                            )
                        )
                    )
                ),

                // Bot√≥n para agregar movimiento
                React.createElement('div', { className: 'button-container' },
                    React.createElement('button', {
                        className: 'btn btn-primary',
                        onClick: agregarMovimiento
                    }, 'Agregar Nuevo Movimiento')
                )
            );
        }

        // Renderizar la aplicaci√≥n
        ReactDOM.render(React.createElement(Movimientos), document.getElementById('root'));
    </script>
</body>
</html>