<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Empleados</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { padding: 20px; font-family: Arial; background-color: white; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); border: 1px solid #e0e0e0; }
        h1 { text-align: center; margin-bottom: 2rem; color: #333; }
        .header-info { text-align: center; margin-bottom: 1rem; color: #666; }
        .filters { display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .filter-group { flex: 1; min-width: 200px; }
        .filter-group label { display: block; margin-bottom: 0.5rem; color: #333; }
        .filter-group input { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
        .filter-group input:focus { outline: none; border-color: #ff69b4; }
        .employee-table { width: 100%; border-collapse: collapse; margin-bottom: 2rem; }
        .employee-table th, .employee-table td { padding: 1rem; text-align: left; border-bottom: 1px solid #e0e0e0; }
        .employee-table th { background-color: #f8f9fa; font-weight: bold; color: #333; }
        .employee-table tr:hover { background-color: #f8f9fa; cursor: pointer; }
        .status-active { color: #28a745; font-weight: bold; }
        .status-inactive { color: #dc3545; font-weight: bold; }
        .button-container { text-align: center; margin-bottom: 1rem; }
        .btn-primary { padding: 0.75rem 2rem; background-color: #ff69b4; color: white; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; margin: 0 0.5rem; }
        .btn-primary:hover { background-color: #ff1493; }
        .btn-secondary { padding: 0.75rem 2rem; background-color: #6c757d; color: white; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; margin: 0 0.5rem; }
        .btn-secondary:hover { background-color: #5a6268; }
        .loading { text-align: center; padding: 2rem; color: #666; }
        .no-data { text-align: center; padding: 2rem; color: #666; font-style: italic; }
        .error-message { background-color: #ffe6e6; color: #d63384; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; text-align: center; }
        .success-message { background-color: #f0fff4; color: #28a745; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; text-align: center; }
        .user-info { background-color: #e7f3ff; padding: 0.5rem 1rem; border-radius: 4px; margin-bottom: 1rem; text-align: center; }
        .logout-btn { 
            background: none; 
            border: none; 
            color: #ff69b4; 
            cursor: pointer; 
            text-decoration: underline; 
            margin-left: 1rem;
            padding: 0.25rem 0.5rem;
        }
        .logout-btn:hover { color: #ff1493; }
        .logout-loading { color: #666; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function InsertarEmpleadoForm({ onClose, onEmpleadoInsertado }) {
            const [formData, setFormData] = useState({
                idPuesto: '',
                valorDocumentoIdentidad: '',
                nombre: '',
                fechaContratacion: ''
            });
            const [puestos, setPuestos] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [cargandoPuestos, setCargandoPuestos] = useState(true);

            // Obtener userId del login
            const userId = localStorage.getItem('userId') || 1;

            // Cargar puestos al montar el componente
            useEffect(() => {
                cargarPuestos();
            }, []);

            const cargarPuestos = async () => {
    try {
        const response = await fetch('http://25.46.106.44:3000/api/puestos');
        console.log("Response status:", response.status); 
        
        if (response.ok) {
            const data = await response.json();
            console.log("Puestos recibidos:", data); 
            setPuestos(data);
        } else {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        console.error('Error cargando puestos:', error);
        setError('Error al cargar la lista de puestos: ' + error.message);
        setPuestos([
            { Id: 1, Nombre: 'Albañil' },
            { Id: 2, Nombre: 'Asistente' },
            { Id: 3, Nombre: 'Cajero' },
            { Id: 4, Nombre: 'Camarero' },
            { Id: 5, Nombre: 'Conductor' },
            { Id: 6, Nombre: 'Conserje' },
            { Id: 7, Nombre: 'Cuidador' },
            { Id: 8, Nombre: 'Fontanero' },
            { Id: 9, Nombre: 'Niñera' },
            { Id: 10, Nombre: 'Recepcionista' }
        ]);
    } finally {
        setCargandoPuestos(false);
    }
};

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                // Validaciones
                if (!formData.idPuesto || !formData.valorDocumentoIdentidad || !formData.nombre || !formData.fechaContratacion) {
                    setError('Todos los campos son requeridos');
                    setLoading(false);
                    return;
                }

                // Validar que la cédula sea numérica
                if (!/^\d+$/.test(formData.valorDocumentoIdentidad)) {
                    setError('La cédula debe contener solo números');
                    setLoading(false);
                    return;
                }

                try {
                    const response = await fetch('http://25.46.106.44:3000/api/empleados', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            ...formData,
                            userId: userId 
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('✅ Empleado insertado correctamente');
                        onEmpleadoInsertado();
                        onClose();
                    } else {
                        setError(result.message || 'Error al insertar empleado');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    setError('Error de conexión con el servidor');
                } finally {
                    setLoading(false);
                }
            };

            const handleChange = (field, value) => {
                setFormData(prev => ({
                    ...prev,
                    [field]: value
                }));
            };

            return React.createElement('div', { 
                style: { 
                    position: 'fixed', 
                    top: 0, 
                    left: 0, 
                    right: 0, 
                    bottom: 0, 
                    backgroundColor: 'rgba(0,0,0,0.5)', 
                    display: 'flex', 
                    justifyContent: 'center', 
                    alignItems: 'center',
                    zIndex: 1000
                } 
            },
                React.createElement('div', { 
                    style: { 
                        backgroundColor: 'white', 
                        padding: '2rem', 
                        borderRadius: '8px', 
                        width: '90%', 
                        maxWidth: '500px',
                        boxShadow: '0 4px 20px rgba(0,0,0,0.2)'
                    } 
                },
                    React.createElement('h2', { style: { marginBottom: '1.5rem', color: '#333' } }, 'Insertar Nuevo Empleado'),
                    
                    error && React.createElement('div', { 
                        style: { 
                            backgroundColor: '#ffe6e6', 
                            color: '#d63384', 
                            padding: '0.75rem', 
                            borderRadius: '4px', 
                            marginBottom: '1rem' 
                        } 
                    }, error),
                    
                    React.createElement('form', { onSubmit: handleSubmit },
                        // Campo Puesto
                        React.createElement('div', { style: { marginBottom: '1rem' } },
                            React.createElement('label', { 
                                style: { display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' } 
                            }, 'Puesto:'),
                            cargandoPuestos ? (
                                React.createElement('div', { style: { padding: '0.75rem', textAlign: 'center', color: '#666' } }, 'Cargando puestos...')
                            ) : (
                                React.createElement('select', {
                                    value: formData.idPuesto,
                                    onChange: (e) => handleChange('idPuesto', e.target.value),
                                    style: { width: '100%', padding: '0.75rem', border: '1px solid #ddd', borderRadius: '4px' },
                                    disabled: loading
                                },
                                    React.createElement('option', { value: '' }, 'Seleccionar puesto'),
                                    puestos.map(puesto => 
                                        React.createElement('option', { 
                                            key: puesto.Id, 
                                            value: puesto.Id 
                                        }, puesto.Nombre)
                                    )
                                )
                            )
                        ),
                        
                        // Campo Cédula
                        React.createElement('div', { style: { marginBottom: '1rem' } },
                            React.createElement('label', { 
                                style: { display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' } 
                            }, 'Cédula:'),
                            React.createElement('input', {
                                type: 'text',
                                value: formData.valorDocumentoIdentidad,
                                onChange: (e) => handleChange('valorDocumentoIdentidad', e.target.value),
                                placeholder: 'Ej: 123456789 (solo números)',
                                style: { width: '100%', padding: '0.75rem', border: '1px solid #ddd', borderRadius: '4px' },
                                disabled: loading
                            })
                        ),
                        
                        // Campo Nombre
                        React.createElement('div', { style: { marginBottom: '1rem' } },
                            React.createElement('label', { 
                                style: { display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' } 
                            }, 'Nombre Completo:'),
                            React.createElement('input', {
                                type: 'text',
                                value: formData.nombre,
                                onChange: (e) => handleChange('nombre', e.target.value),
                                placeholder: 'Ej: Juan Pérez García',
                                style: { width: '100%', padding: '0.75rem', border: '1px solid #ddd', borderRadius: '4px' },
                                disabled: loading
                            })
                        ),
                        
                        // Campo Fecha
                        React.createElement('div', { style: { marginBottom: '1.5rem' } },
                            React.createElement('label', { 
                                style: { display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' } 
                            }, 'Fecha de Contratación:'),
                            React.createElement('input', {
                                type: 'date',
                                value: formData.fechaContratacion,
                                onChange: (e) => handleChange('fechaContratacion', e.target.value),
                                style: { width: '100%', padding: '0.75rem', border: '1px solid #ddd', borderRadius: '4px' },
                                disabled: loading
                            })
                        ),
                        
                        // Botones
                        React.createElement('div', { style: { display: 'flex', gap: '1rem', justifyContent: 'flex-end' } },
                            React.createElement('button', {
                                type: 'button',
                                onClick: onClose,
                                style: { 
                                    padding: '0.75rem 1.5rem', 
                                    backgroundColor: '#6c757d', 
                                    color: 'white', 
                                    border: 'none', 
                                    borderRadius: '4px',
                                    cursor: 'pointer'
                                },
                                disabled: loading
                            }, 'Cancelar'),
                            React.createElement('button', {
                                type: 'submit',
                                style: { 
                                    padding: '0.75rem 1.5rem', 
                                    backgroundColor: '#ff69b4', 
                                    color: 'white', 
                                    border: 'none', 
                                    borderRadius: '4px',
                                    cursor: loading ? 'not-allowed' : 'pointer',
                                    opacity: loading ? 0.7 : 1
                                },
                                disabled: loading || cargandoPuestos
                            }, loading ? 'Insertando...' : 'Insertar Empleado')
                        )
                    )
                )
            );
        }

        // Componente principal
        function EmployeeTable() {
            const [employees, setEmployees] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filters, setFilters] = useState({ nombre: '', cedula: '' });
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const [mostrarFormulario, setMostrarFormulario] = useState(false);
            const [logoutLoading, setLogoutLoading] = useState(false);

            // Obtener información del usuario logueado
            const username = localStorage.getItem('username') || 'Usuario';
            const userId = localStorage.getItem('userId') || '1';
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';

            useEffect(() => {
                if (!isLoggedIn) {
                    setError('⚠️ Debes iniciar sesión primero');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                cargarEmpleados();
            }, [isLoggedIn]);

            const cargarEmpleados = async () => {
                setLoading(true);
                setError('');
                try {
                    console.log("🔄 Cargando empleados...");
                    const response = await fetch('http://25.46.106.44:3000/api/empleados');
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log("Empleados cargados:", data.length);
                        setEmployees(data);
                        setSuccess(`${data.length} empleados cargados correctamente`);
                    } else {
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error("❌ Error cargando empleados:", error);
                    setError('No se pudieron cargar los empleados. Verifica que el backend esté ejecutándose.');
                    
                    setEmployees([
                        { 
                            Id: 1, 
                            Nombre: 'Juan Pérez (Ejemplo)', 
                            ValorDocumentoIdentidad: '123456789', 
                            PuestoNombre: 'Desarrollador',
                            SaldoVacaciones: 15, 
                            EsActivo: true 
                        },
                        { 
                            Id: 2, 
                            Nombre: 'María García (Ejemplo)', 
                            ValorDocumentoIdentidad: '987654321', 
                            PuestoNombre: 'Diseñadora',
                            SaldoVacaciones: 8, 
                            EsActivo: true 
                        }
                    ]);
                } finally {
                    setLoading(false);
                }
            };

            const handleLogout = async () => {
                setLogoutLoading(true);
                try {
                    const response = await fetch('http://25.46.106.44:3000/api/logout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            userId: userId,
                            username: username
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        console.log('✅ Logout exitoso - Bitácora registrada');
                    } else {
                        console.log('⚠️ Logout completado pero sin bitácora:', result.message);
                    }
                } catch (error) {
                    console.error('❌ Error en logout (continuando de todas formas):', error);
                } finally {
                    localStorage.removeItem('userId');
                    localStorage.removeItem('username');
                    localStorage.removeItem('isLoggedIn');
                    window.location.href = 'login.html';
                }
            };

            // Filtrar empleados
            const filteredEmployees = employees.filter(employee => {
                const nombre = employee.Nombre || employee.nombre || '';
                const cedula = employee.ValorDocumentoIdentidad || employee.cedula || '';
                
                const nombreMatch = nombre.toLowerCase().includes(filters.nombre.toLowerCase());
                const cedulaMatch = cedula.includes(filters.cedula);
                
                if (filters.nombre === '' && filters.cedula === '') {
                    return true;
                }
                
                return nombreMatch && cedulaMatch;
            });

            const handleFilterChange = (filterType, value) => {
                setFilters(prev => ({
                    ...prev,
                    [filterType]: value
                }));
            };

            const abrirActualizar = (employee) => {
                const employeeData = encodeURIComponent(JSON.stringify({
                    Id: employee.Id || employee.id,
                    Nombre: employee.Nombre || employee.nombre,
                    ValorDocumentoIdentidad: employee.ValorDocumentoIdentidad || employee.cedula,
                    IdPuesto: employee.IdPuesto || employee.idPuesto,
                    SaldoVacaciones: employee.SaldoVacaciones || employee.saldoVacaciones,
                    EsActivo: employee.EsActivo !== undefined ? employee.EsActivo : employee.activo,
                    PuestoNombre: employee.PuestoNombre || employee.puestoNombre
                }));
                
                window.open(`actualizar.html?id=${employee.Id}&employeeData=${employeeData}`, '_blank');
            };

            const abrirFormulario = () => {
                setMostrarFormulario(true);
            };

            const cerrarFormulario = () => {
                setMostrarFormulario(false);
            };

            const recargarEmpleados = () => {
                cargarEmpleados();
            };

            if (loading) {
                return React.createElement('div', { className: 'container' },
                    React.createElement('h1', null, 'Lista de Empleados'),
                    React.createElement('div', { className: 'loading' }, '🔄 Cargando empleados...')
                );
            }

            if (!isLoggedIn) {
                return React.createElement('div', { className: 'container' },
                    React.createElement('h1', null, 'Acceso Denegado'),
                    React.createElement('div', { className: 'error-message' }, 
                        'Debes iniciar sesión primero. Redirigiendo...'
                    )
                );
            }

            return React.createElement('div', { className: 'container' },
                React.createElement('h1', null, 'Lista de Empleados'),
                
                // Información del usuario
                React.createElement('div', { className: 'user-info' },
                    ` Conectado como: ${username} (ID: ${userId}) `,
                    React.createElement('button', {
                        className: 'logout-btn',
                        onClick: handleLogout,
                        disabled: logoutLoading
                    }, logoutLoading ? 'Cerrando sesión...' : 'Cerrar Sesión')
                ),
                
                // Mensajes de éxito y error
                error && React.createElement('div', { className: 'error-message' }, error),
                success && React.createElement('div', { className: 'success-message' }, success),
                
                // Botones de acción
                React.createElement('div', { className: 'button-container' },
                    React.createElement('button', {
                        onClick: recargarEmpleados,
                        className: 'btn-secondary'
                    }, 'Recargar'),
                    React.createElement('button', {
                        onClick: abrirFormulario,
                        className: 'btn-primary'
                    }, 'Insertar Empleado')
                ),

                // Filtros
                React.createElement('div', { className: 'filters' },
                    React.createElement('div', { className: 'filter-group' },
                        React.createElement('label', null, 'Filtrar por Nombre:'),
                        React.createElement('input', {
                            type: 'text',
                            placeholder: 'Ej: Juan Pérez',
                            value: filters.nombre,
                            onChange: (e) => handleFilterChange('nombre', e.target.value)
                        })
                    ),
                    React.createElement('div', { className: 'filter-group' },
                        React.createElement('label', null, 'Filtrar por Cédula:'),
                        React.createElement('input', {
                            type: 'text',
                            placeholder: 'Ej: 123456789',
                            value: filters.cedula,
                            onChange: (e) => handleFilterChange('cedula', e.target.value)
                        })
                    )
                ),

                // Contador de resultados
                React.createElement('p', { style: { marginBottom: '1rem', color: '#666' } }, 
                    `Mostrando ${filteredEmployees.length} de ${employees.length} empleados`),

                // Tabla 
                React.createElement('table', { className: 'employee-table' },
                    React.createElement('thead', null,
                        React.createElement('tr', null,
                            React.createElement('th', null, 'ID'),
                            React.createElement('th', null, 'Nombre'),
                            React.createElement('th', null, 'Cédula'),
                            React.createElement('th', null, 'Puesto'),
                            React.createElement('th', null, 'Saldo Vacaciones'),
                            React.createElement('th', null, 'Activo')
                        )
                    ),
                    React.createElement('tbody', null,
                        filteredEmployees.length > 0 ? (
                            filteredEmployees.map(employee => {
                                const id = employee.Id || employee.id;
                                const nombre = employee.Nombre || employee.nombre;
                                const cedula = employee.ValorDocumentoIdentidad || employee.cedula;
                                const puesto = employee.PuestoNombre || 'Sin puesto';
                                const saldo = employee.SaldoVacaciones || employee.saldoVacaciones || 0;
                                const activo = employee.EsActivo !== undefined ? employee.EsActivo : employee.activo;
                                
                                return React.createElement('tr', { 
                                    key: id,
                                    onClick: () => abrirActualizar(employee), 
                                    style: { cursor: 'pointer' }
                                },
                                    React.createElement('td', null, id),
                                    React.createElement('td', null, nombre),
                                    React.createElement('td', null, cedula),
                                    React.createElement('td', null, puesto),
                                    React.createElement('td', null, `${saldo} días`),
                                    React.createElement('td', null,
                                        React.createElement('span', { 
                                            className: activo ? 'status-active' : 'status-inactive'
                                        }, activo ? 'Sí' : 'No')
                                    )
                                );
                            })
                        ) : (
                            React.createElement('tr', null,
                                React.createElement('td', { 
                                    colSpan: '6', 
                                    className: 'no-data'
                                }, employees.length === 0 ? 
                                    'No hay empleados registrados' : 
                                    'No se encontraron empleados con los filtros aplicados'
                                )
                            )
                        )
                    )
                ),

                // Formulario modal
                mostrarFormulario && React.createElement(InsertarEmpleadoForm, {
                    onClose: cerrarFormulario,
                    onEmpleadoInsertado: recargarEmpleados
                })
            );
        }

        // Render con React 18
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(EmployeeTable));
    </script>
</body>
</html>